name: Deploy to Production

on:
  push:
    tags:
      - 'release-*'  # Triggers on tags like release-20260204-2048

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PROD_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup of current production
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
          BACKUP_NAME: backup-${{ github.ref_name }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << EOF
            echo "ðŸ“¦ Creating backup: ${BACKUP_NAME}"

            # Create backup directory
            mkdir -p /var/backups/boardcrewcial/${BACKUP_NAME}

            # Backup current production files (fast, uses hard links)
            rsync -a --no-g --no-perms --no-owner --omit-dir-times --link-dest=/var/www/boardcrewcial/ \
              /var/www/boardcrewcial/ \
              /var/backups/boardcrewcial/${BACKUP_NAME}/

            # Store backup timestamp and tag info
            echo "Tag: ${{ github.ref_name }}" > /var/backups/boardcrewcial/${BACKUP_NAME}/BACKUP_INFO
            echo "Date: \$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> /var/backups/boardcrewcial/${BACKUP_NAME}/BACKUP_INFO
            echo "Commit: ${{ github.sha }}" >> /var/backups/boardcrewcial/${BACKUP_NAME}/BACKUP_INFO

            echo "âœ… Backup created at /var/backups/boardcrewcial/${BACKUP_NAME}"
            du -sh /var/backups/boardcrewcial/${BACKUP_NAME}
          EOF

      - name: Deploy to production
        id: deploy
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
        run: |
          echo "ðŸš€ Deploying code to production"

          rsync -avz --no-g --no-perms --no-owner --omit-dir-times -e "ssh -i ~/.ssh/deploy_key -p ${SSH_PORT}" \
            --delete \
            `# Repository metadata (don't deploy)` \
            --exclude='.git' \
            --exclude='.gitignore' \
            --exclude='.github' \
            `# Production configuration (don't overwrite)` \
            --exclude='config/' \
            --exclude='.env' \
            --exclude='docker/sphinx/sphinx.conf' \
            --exclude='docker-compose.override.yml' \
            `# Development files (don't deploy)` \
            --exclude='tests/' \
            --exclude='phpunit.xml' \
            --exclude='Makefile' \
            --exclude='scripts/' \
            --exclude='README.md' \
            --exclude='CHANGELOG' \
            --exclude='.example.env' \
            --exclude='*.default.php' \
            --exclude='docker-compose.yml' \
            `# Production-specific assets (don't overwrite)` \
            --exclude='lib/gif/partyshark.gif' \
            --exclude='favicon.ico' \
            --exclude='robots.txt' \
            ./ ${SSH_USER}@${SSH_HOST}:/var/www/boardcrewcial/

          echo "âœ… Code deployed successfully"

      - name: Rebuild and restart containers
        id: restart
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
        run: |
          echo "ðŸ”„ Rebuilding and restarting containers"

          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'EOF'
            cd /var/www/boardcrewcial

            echo "Building Docker images (pulls latest base images)..."
            docker compose -f docker-compose.prod.yml build --pull

            echo "Starting containers with new images..."
            docker compose -f docker-compose.prod.yml up -d

            echo "Checking container status after restart..."
            docker ps -a | grep boardcrewcial || echo "No boardcrewcial containers found"

            echo "Waiting for containers to be healthy..."
            docker compose -f docker-compose.prod.yml up -d --wait || {
              echo "âš ï¸  Wait command failed or timed out"
              echo "Container status:"
              docker ps -a | grep boardcrewcial
              echo "Web container logs:"
              docker logs boardcrewcial_web --tail 50
            }
          EOF

      - name: Health check
        id: health_check
        run: |
          echo "ðŸ¥ Running health checks"

          # Check if website responds (containers already verified healthy by --wait)
          echo "Checking website response..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://boardcrewcial.com --max-time 10)

          if [ "$RESPONSE" != "200" ]; then
            echo "âŒ Website returned HTTP $RESPONSE"
            exit 1
          fi

          echo "âœ… Website is responding (HTTP 200)"
          echo "âœ… Deployment health check passed"

      - name: Rollback on failure
        if: failure() && (steps.deploy.outcome == 'failure' || steps.restart.outcome == 'failure' || steps.health_check.outcome == 'failure')
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
          BACKUP_NAME: backup-${{ github.ref_name }}
        run: |
          echo "âš ï¸  DEPLOYMENT FAILED - Initiating automatic rollback"

          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << EOF
            echo "ðŸ”™ Rolling back to backup: ${BACKUP_NAME}"

            # Restore from backup
            rsync -a --no-g --no-perms --no-owner --omit-dir-times --delete \
              --exclude='config/' \
              --exclude='.env' \
              --exclude='docker/sphinx/sphinx.conf' \
              --exclude='lib/gif/partyshark.gif' \
              --exclude='favicon.ico' \
              --exclude='robots.txt' \
              /var/backups/boardcrewcial/${BACKUP_NAME}/ \
              /var/www/boardcrewcial/

            # Restart containers
            cd /var/www/boardcrewcial
            docker compose -f docker-compose.prod.yml restart
            docker compose -f docker-compose.prod.yml up -d --wait

            echo "âœ… Rollback completed"
            docker ps | grep boardcrewcial
          EOF

          echo "âŒ Deployment was rolled back. Check logs above for errors."
          exit 1

      - name: Cleanup old backups
        if: success()
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
        run: |
          echo "ðŸ§¹ Cleaning up old backups (keeping last 5)"

          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'EOF'
            cd /var/backups/boardcrewcial

            # List backups sorted by modification time
            BACKUP_COUNT=$(ls -dt backup-* 2>/dev/null | wc -l)

            if [ "$BACKUP_COUNT" -gt 5 ]; then
              echo "Found $BACKUP_COUNT backups, removing oldest..."
              ls -dt backup-* | tail -n +6 | xargs rm -rf
              echo "âœ… Old backups removed"
            else
              echo "âœ… Only $BACKUP_COUNT backups exist, no cleanup needed"
            fi

            echo ""
            echo "Current backups:"
            ls -lth backup-* 2>/dev/null | head -10 || echo "No backups found"
          EOF

      - name: Deployment summary
        if: success()
        env:
          SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
        run: |
          echo "âœ… Deployment successful!"
          echo ""
          echo "ðŸ“‹ Deployment Summary:"
          echo "  Tag: ${{ github.ref_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Backup: /var/backups/boardcrewcial/backup-${{ github.ref_name }}"
          echo ""

          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'EOF'
            echo "=== Container Status ==="
            docker ps | grep boardcrewcial
            echo ""
            echo "=== Recent Web Logs ==="
            docker logs boardcrewcial_web --tail 10
            echo ""
            echo "=== Recent Sphinx Logs ==="
            docker logs boardcrewcial_sphinx --tail 10
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key